<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimDecision - å†³ç­–ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 500;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: #10b981;
            box-shadow: 0 0 8px #10b981;
        }

        .status-offline {
            background: #ef4444;
        }

        .workflow-steps {
            margin-top: 20px;
        }

        .step {
            background: #f8f9fa;
            border-left: 4px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .step.running {
            border-left-color: #3b82f6;
            background: #eff6ff;
        }

        .step.success {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        .step.failed {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .step-name {
            font-weight: 600;
            font-size: 1.1em;
            color: #333;
        }

        .step-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .step-status.running {
            background: #3b82f6;
            color: white;
        }

        .step-status.success {
            background: #10b981;
            color: white;
        }

        .step-status.failed {
            background: #ef4444;
            color: white;
        }

        .step-endpoint {
            margin-top: 10px;
            padding: 8px;
            background: #f0f9ff;
            border-left: 3px solid #3b82f6;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .step-endpoint strong {
            color: #1e40af;
        }

        .step-result {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
        }

        .result-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .result-summary h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .result-item {
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
        }

        .result-item strong {
            color: #667eea;
        }

        .target-list {
            margin-top: 10px;
        }

        .target-item {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .service-status {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .service-item {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: help;
        }

        .error-message {
            color: #ef4444;
            font-size: 0.9em;
            margin-top: 5px;
            padding: 8px;
            background: #fef2f2;
            border-left: 3px solid #ef4444;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš¢ SimDecision å†³ç­–ç³»ç»Ÿ</h1>
            <p>èˆªè·¯è§„åˆ’ â†’ èˆªæ§å¯åŠ¨ â†’ å£°çº³æ¢æµ‹ â†’ ç›®æ ‡è¯†åˆ« â†’ ç›®æ ‡æ‰“å‡»</p>
        </div>

        <div class="content">
            <!-- æœåŠ¡çŠ¶æ€ -->
            <div class="section">
                <h2>æœåŠ¡çŠ¶æ€</h2>
                        <div class="service-status" id="serviceStatus">
                            <div class="service-item">
                                <span class="status-indicator status-offline" id="statusRoutePlan"></span>
                                <span>SimRoutePlan</span>
                            </div>
                            <div class="service-item">
                                <span class="status-indicator status-offline" id="statusNaviControl"></span>
                                <span>SimNaviControl</span>
                            </div>
                            <div class="service-item">
                                <span class="status-indicator status-offline" id="statusSonar"></span>
                                <span>SimSonar</span>
                            </div>
                            <div class="service-item">
                                <span class="status-indicator status-offline" id="statusTargetRecognize"></span>
                                <span>SimTargetRecognize</span>
                            </div>
                            <div class="service-item">
                                <span class="status-indicator status-offline" id="statusTargetHit"></span>
                                <span>SimTargetHit</span>
                            </div>
                        </div>
                <div id="serviceMessages"></div>
            </div>

            <!-- è¾“å…¥å‚æ•° -->
            <div class="section">
                <h2>è¾“å…¥å‚æ•°</h2>
                <form id="workflowForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>èµ·ç‚¹ç»åº¦ (longitude)</label>
                            <input type="number" id="point1Lon" step="0.000001" value="116.0" required>
                        </div>
                        <div class="form-group">
                            <label>èµ·ç‚¹çº¬åº¦ (latitude)</label>
                            <input type="number" id="point1Lat" step="0.000001" value="39.0" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ç»ˆç‚¹ç»åº¦ (longitude)</label>
                            <input type="number" id="point2Lon" step="0.000001" value="116.1" required>
                        </div>
                        <div class="form-group">
                            <label>ç»ˆç‚¹çº¬åº¦ (latitude)</label>
                            <input type="number" id="point2Lat" step="0.000001" value="39.1" required>
                        </div>
                    </div>
                    <button type="submit" class="btn" id="executeBtn">æ‰§è¡Œå†³ç­–æµç¨‹</button>
                </form>
            </div>

            <!-- æ‰§è¡Œæµç¨‹ -->
            <div class="section" id="workflowSection" style="display: none;">
                <h2>æ‰§è¡Œæµç¨‹</h2>
                <div class="workflow-steps" id="workflowSteps"></div>
                <div class="result-summary" id="resultSummary" style="display: none;">
                    <h3>æ‰§è¡Œç»“æœ</h3>
                    <div id="resultContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ£€æŸ¥æœåŠ¡çŠ¶æ€
        async function checkServiceStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                updateStatusIndicator('statusRoutePlan', status.route_plan, status.messages?.route_plan || '');
                updateStatusIndicator('statusNaviControl', status.navi_control, status.messages?.navi_control || '');
                updateStatusIndicator('statusSonar', status.sonar, status.messages?.sonar || '');
                updateStatusIndicator('statusTargetRecognize', status.target_recognize, status.messages?.target_recognize || '');
                updateStatusIndicator('statusTargetHit', status.target_hit, status.messages?.target_hit || '');
            } catch (error) {
                console.error('æ£€æŸ¥æœåŠ¡çŠ¶æ€å¤±è´¥:', error);
            }
        }

        function updateStatusIndicator(id, online, message) {
            const indicator = document.getElementById(id);
            indicator.className = 'status-indicator ' + (online ? 'status-online' : 'status-offline');
            
            // æ›´æ–°æç¤ºä¿¡æ¯
            const serviceItem = indicator.parentElement;
            if (serviceItem && message) {
                serviceItem.title = message;
            }
            
            // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
            const messagesDiv = document.getElementById('serviceMessages');
            if (messagesDiv) {
                let html = '';
                const serviceNames = {
                    'statusRoutePlan': 'SimRoutePlan',
                    'statusNaviControl': 'SimNaviControl',
                    'statusSonar': 'SimSonar'
                };
                
                if (!online && message) {
                    const serviceName = serviceNames[id] || id;
                    html += `<div class="error-message"><strong>${serviceName}:</strong> ${message}</div>`;
                }
                messagesDiv.innerHTML = html;
            }
        }

        // æ‰§è¡Œæµç¨‹
        document.getElementById('workflowForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const point1 = {
                longitude: parseFloat(document.getElementById('point1Lon').value),
                latitude: parseFloat(document.getElementById('point1Lat').value)
            };
            
            const point2 = {
                longitude: parseFloat(document.getElementById('point2Lon').value),
                latitude: parseFloat(document.getElementById('point2Lat').value)
            };

            const executeBtn = document.getElementById('executeBtn');
            executeBtn.disabled = true;
            executeBtn.textContent = 'æ‰§è¡Œä¸­...';

            document.getElementById('workflowSection').style.display = 'block';
            document.getElementById('workflowSteps').innerHTML = '';
            document.getElementById('resultSummary').style.display = 'none';

            const steps = [
                { name: 'èˆªè·¯è§„åˆ’', id: 'step1' },
                { name: 'å¯åŠ¨èˆªæ§', id: 'step2' },
                { name: 'å£°çº³æ¢æµ‹', id: 'step3' }
            ];

            steps.forEach((step, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'step';
                stepDiv.id = step.id;
                stepDiv.innerHTML = `
                    <div class="step-header">
                        <span class="step-name">${step.name}</span>
                        <span class="step-status">ç­‰å¾…ä¸­</span>
                    </div>
                `;
                document.getElementById('workflowSteps').appendChild(stepDiv);
            });

            try {
                const startTime = Date.now();
                let allResults = {
                    route_plan: null,
                    navi_control: null,
                    sonar: null
                };
                let allEndpoints = {};
                
                // æ­¥éª¤1ï¼šèˆªè·¯è§„åˆ’
                updateStepStatus(1, 'running', null, null);
                try {
                    const response1 = await fetch('/api/call_route_plan', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ point1, point2 })
                    });
                    const result1 = await response1.json();
                    
                    if (result1.success && result1.result) {
                        allResults.route_plan = result1.result;
                        allEndpoints.route_plan = result1.service_endpoint;
                        updateStepStatus(1, 'success', result1.result, result1.service_endpoint);
                    } else {
                        updateStepStatus(1, 'failed', { error: result1.error || 'æœªçŸ¥é”™è¯¯' }, result1.service_endpoint);
                        throw new Error(result1.error || 'èˆªè·¯è§„åˆ’å¤±è´¥');
                    }
                } catch (error) {
                    updateStepStatus(1, 'failed', { error: error.message }, null);
                    throw error;
                }
                
                // æ­¥éª¤2ï¼šå¯åŠ¨èˆªæ§
                updateStepStatus(2, 'running', null, null);
                try {
                    const route = allResults.route_plan.route || [];
                    const response2 = await fetch('/api/call_navi_control', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ route })
                    });
                    const result2 = await response2.json();
                    
                    if (result2.success && result2.result) {
                        allResults.navi_control = result2.result;
                        allEndpoints.navi_control = result2.service_endpoint;
                        updateStepStatus(2, 'success', result2.result, result2.service_endpoint);
                    } else {
                        updateStepStatus(2, 'failed', { error: result2.error || 'æœªçŸ¥é”™è¯¯' }, result2.service_endpoint);
                        throw new Error(result2.error || 'èˆªæ§å¯åŠ¨å¤±è´¥');
                    }
                } catch (error) {
                    updateStepStatus(2, 'failed', { error: error.message }, null);
                    throw error;
                }
                
                // æ­¥éª¤3ï¼šå£°çº³æ¢æµ‹
                updateStepStatus(3, 'running', null, null);
                try {
                    const response3 = await fetch('/api/call_sonar', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    });
                    const result3 = await response3.json();
                    
                    if (result3.success && result3.result) {
                        allResults.sonar = result3.result;
                        allEndpoints.sonar = result3.service_endpoint;
                        updateStepStatus(3, 'success', result3.result, result3.service_endpoint);
                    } else {
                        updateStepStatus(3, 'failed', { error: result3.error || 'æœªçŸ¥é”™è¯¯' }, result3.service_endpoint);
                        throw new Error(result3.error || 'å£°çº³æ¢æµ‹å¤±è´¥');
                    }
                } catch (error) {
                    updateStepStatus(3, 'failed', { error: error.message }, null);
                    throw error;
                }
                
                // æ­¥éª¤4ï¼šç›®æ ‡è¯†åˆ«ï¼ˆå¯¹æ¯ä¸ªæ£€æµ‹åˆ°çš„ç›®æ ‡è¿›è¡Œè¯†åˆ«ï¼‰
                const targets = allResults.sonar?.targets || [];
                allResults.target_recognize = [];
                
                console.log('[SimDecision] å£°çº³æ¢æµ‹ç»“æœ:', allResults.sonar);
                console.log('[SimDecision] æ£€æµ‹åˆ°çš„ç›®æ ‡æ•°é‡:', targets.length);
                console.log('[SimDecision] ç›®æ ‡åˆ—è¡¨:', targets);
                
                if (targets.length > 0) {
                    // ä¸ºæ¯ä¸ªç›®æ ‡åˆ›å»ºè¯†åˆ«æ­¥éª¤
                    for (let i = 0; i < targets.length; i++) {
                        const target = targets[i];
                        const imagePath = target.image_path;
                        const targetId = target.id || (i + 1);
                        
                        console.log(`[SimDecision] å¤„ç†ç›®æ ‡ ${targetId}, image_path: ${imagePath}`);
                        
                        if (imagePath) {
                            // åˆ›å»ºæ­¥éª¤ï¼ˆæ­¥éª¤4, 5, 6...ï¼‰
                            const stepNum = 4 + i;
                            const stepName = `ç›®æ ‡è¯†åˆ« (ç›®æ ‡ ${targetId})`;
                            
                            // åŠ¨æ€æ·»åŠ æ­¥éª¤åˆ°UI
                            const stepDiv = document.createElement('div');
                            stepDiv.className = 'step';
                            stepDiv.id = `step${stepNum}`;
                            stepDiv.innerHTML = `
                                <div class="step-header">
                                    <span class="step-name">${stepName}</span>
                                    <span class="step-status">ç­‰å¾…ä¸­</span>
                                </div>
                            `;
                            document.getElementById('workflowSteps').appendChild(stepDiv);
                            
                            updateStepStatus(stepNum, 'running', null, null);
                            try {
                                console.log(`[SimDecision] è°ƒç”¨ç›®æ ‡è¯†åˆ«æœåŠ¡ï¼Œimage_path: ${imagePath}`);
                                const response4 = await fetch('/api/call_target_recognize', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ image_path: imagePath })
                                });
                                const result4 = await response4.json();
                                
                                console.log(`[SimDecision] ç›®æ ‡è¯†åˆ«ç»“æœ:`, result4);
                                
                                if (result4.success && result4.result) {
                                    allResults.target_recognize.push(result4.result);
                                    allEndpoints[`target_recognize_${targetId}`] = result4.service_endpoint;
                                    updateStepStatus(stepNum, 'success', result4.result, result4.service_endpoint);
                                } else {
                                    console.error(`[SimDecision] ç›®æ ‡è¯†åˆ«å¤±è´¥:`, result4.error);
                                    updateStepStatus(stepNum, 'failed', { error: result4.error || 'æœªçŸ¥é”™è¯¯' }, result4.service_endpoint);
                                }
                            } catch (error) {
                                console.error(`[SimDecision] ç›®æ ‡è¯†åˆ«å¼‚å¸¸:`, error);
                                updateStepStatus(stepNum, 'failed', { error: error.message }, null);
                            }
                        } else {
                            console.warn(`[SimDecision] ç›®æ ‡ ${targetId} æ²¡æœ‰ image_pathï¼Œè·³è¿‡è¯†åˆ«`);
                        }
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°ç›®æ ‡ï¼Œæ˜¾ç¤ºä¸€ä¸ªæç¤ºæ­¥éª¤
                    console.log('[SimDecision] æœªæ£€æµ‹åˆ°ç›®æ ‡ï¼Œè·³è¿‡ç›®æ ‡è¯†åˆ«');
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'step';
                    stepDiv.id = 'step4';
                    stepDiv.innerHTML = `
                        <div class="step-header">
                            <span class="step-name">ç›®æ ‡è¯†åˆ«</span>
                            <span class="step-status">ç­‰å¾…ä¸­</span>
                        </div>
                    `;
                    document.getElementById('workflowSteps').appendChild(stepDiv);
                    updateStepStatus(4, 'success', { message: 'æœªæ£€æµ‹åˆ°ç›®æ ‡ï¼Œè·³è¿‡ç›®æ ‡è¯†åˆ«' }, null);
                }
                
                // æ­¥éª¤5ï¼šç›®æ ‡æ‰“å‡»ï¼ˆå¯¹æ¯ä¸ªè¯†åˆ«æˆåŠŸçš„ç›®æ ‡è¿›è¡Œæ‰“å‡»ï¼‰
                allResults.target_hit = [];
                const recognizeResults = allResults.target_recognize || [];
                
                if (targets.length > 0 && recognizeResults.length > 0) {
                    for (let i = 0; i < targets.length; i++) {
                        const target = targets[i];
                        const imagePath = target.image_path;
                        const targetId = target.id || (i + 1);
                        const longitude = target.longitude;
                        const latitude = target.latitude;
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”çš„è¯†åˆ«ç»“æœä¸”è¯†åˆ«æˆåŠŸ
                        const recognizeResult = recognizeResults.find(r => r && r.image_path === imagePath);
                        
                        if (recognizeResult && recognizeResult.success && longitude && latitude) {
                            // åˆ›å»ºæ­¥éª¤ï¼ˆæ­¥éª¤4+N, 4+N+1...ï¼‰
                            const stepNum = 4 + targets.length + i;
                            const stepName = `ç›®æ ‡æ‰“å‡» (ç›®æ ‡ ${targetId})`;
                            
                            // åŠ¨æ€æ·»åŠ æ­¥éª¤åˆ°UI
                            const stepDiv = document.createElement('div');
                            stepDiv.className = 'step';
                            stepDiv.id = `step${stepNum}`;
                            stepDiv.innerHTML = `
                                <div class="step-header">
                                    <span class="step-name">${stepName}</span>
                                    <span class="step-status">ç­‰å¾…ä¸­</span>
                                </div>
                            `;
                            document.getElementById('workflowSteps').appendChild(stepDiv);
                            
                            updateStepStatus(stepNum, 'running', null, null);
                            try {
                                console.log(`[SimDecision] è°ƒç”¨ç›®æ ‡æ‰“å‡»æœåŠ¡ï¼Œtarget_id: ${targetId}, longitude: ${longitude}, latitude: ${latitude}`);
                                const response5 = await fetch('/api/call_target_hit', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ 
                                        id: targetId,
                                        longitude: longitude,
                                        latitude: latitude
                                    })
                                });
                                const result5 = await response5.json();
                                
                                console.log(`[SimDecision] ç›®æ ‡æ‰“å‡»ç»“æœ:`, result5);
                                
                                if (result5.success && result5.result) {
                                    allResults.target_hit.push(result5.result);
                                    allEndpoints[`target_hit_${targetId}`] = result5.service_endpoint;
                                    updateStepStatus(stepNum, 'success', result5.result, result5.service_endpoint);
                                } else {
                                    console.error(`[SimDecision] ç›®æ ‡æ‰“å‡»å¤±è´¥:`, result5);
                                    // å¦‚æœé”™è¯¯ä¿¡æ¯åŒ…å« JSON è§£æé”™è¯¯ï¼Œæä¾›æ›´å‹å¥½çš„æç¤º
                                    let errorMsg = result5.error || 'æœªçŸ¥é”™è¯¯';
                                    if (errorMsg.includes('Unexpected token') || errorMsg.includes('<!doctype')) {
                                        errorMsg = 'æœåŠ¡è¿”å›äº†éJSONå“åº”ï¼Œè¯·æ£€æŸ¥ SimTargetHit æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ';
                                    }
                                    updateStepStatus(stepNum, 'failed', { error: errorMsg }, result5.service_endpoint);
                                }
                            } catch (error) {
                                console.error(`[SimDecision] ç›®æ ‡æ‰“å‡»å¼‚å¸¸:`, error);
                                let errorMsg = error.message;
                                if (errorMsg.includes('Unexpected token') || errorMsg.includes('<!doctype')) {
                                    errorMsg = 'æœåŠ¡è¿”å›äº†éJSONå“åº”ï¼Œè¯·æ£€æŸ¥ SimTargetHit æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ';
                                }
                                updateStepStatus(stepNum, 'failed', { error: errorMsg }, null);
                            }
                        }
                    }
                }
                
                // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
                const totalTime = (Date.now() - startTime) / 1000; // è½¬æ¢ä¸ºç§’
                displayResults({
                    results: allResults,
                    service_endpoints: allEndpoints,
                    workflow: {
                        total_time: totalTime
                    }
                });

            } catch (error) {
                console.error('æ‰§è¡Œå¤±è´¥:', error);
                alert('æ‰§è¡Œå¤±è´¥: ' + error.message);
            } finally {
                executeBtn.disabled = false;
                executeBtn.textContent = 'æ‰§è¡Œå†³ç­–æµç¨‹';
            }
        });

        function updateStepStatus(stepNum, status, result, endpointInfo) {
            const stepDiv = document.getElementById(`step${stepNum}`);
            if (!stepDiv) return;

            stepDiv.className = `step ${status}`;
            
            const statusSpan = stepDiv.querySelector('.step-status');
            const statusText = {
                'running': 'æ‰§è¡Œä¸­',
                'success': 'æˆåŠŸ',
                'failed': 'å¤±è´¥'
            };
            statusSpan.textContent = statusText[status] || status;
            statusSpan.className = `step-status ${status}`;

            // æ˜¾ç¤ºæœåŠ¡ç«¯ç‚¹ä¿¡æ¯ï¼ˆåªæ˜¾ç¤ºä»æœåŠ¡å‘ç°è·å–çš„åœ°å€ï¼‰
            // å…ˆç§»é™¤å·²å­˜åœ¨çš„ç«¯ç‚¹ä¿¡æ¯ divï¼Œé¿å…é‡å¤æ˜¾ç¤º
            const existingEndpointDiv = stepDiv.querySelector('.step-endpoint');
            if (existingEndpointDiv) {
                existingEndpointDiv.remove();
            }
            
            // åªæœ‰åœ¨æœ‰ç«¯ç‚¹ä¿¡æ¯æ—¶æ‰æ˜¾ç¤º
            if (endpointInfo) {
                const endpointDiv = document.createElement('div');
                endpointDiv.className = 'step-endpoint';
                endpointDiv.style.cssText = 'margin-top: 10px; padding: 8px; background: #f0f9ff; border-left: 3px solid #3b82f6; border-radius: 4px; font-size: 0.9em;';
                let endpointHtml = '<strong>æœåŠ¡åœ°å€:</strong> ';
                
                // æ£€æŸ¥ç«¯ç‚¹ä¿¡æ¯æ˜¯å¦å­˜åœ¨ä¸”æœ‰æœ‰æ•ˆæ•°æ®
                if (endpointInfo.ip && endpointInfo.port) {
                    endpointHtml += `${endpointInfo.protocol || 'http'}://${endpointInfo.ip}:${endpointInfo.port}`;
                    if (endpointInfo.nodeId) {
                        endpointHtml += ` | <strong>èŠ‚ç‚¹:</strong> ${endpointInfo.nodeId}`;
                    }
                    if (endpointInfo.instanceId) {
                        endpointHtml += ` | <strong>å®ä¾‹:</strong> ${endpointInfo.instanceId}`;
                    }
                } else if (endpointInfo.ip || endpointInfo.port) {
                    // æœ‰éƒ¨åˆ†ä¿¡æ¯ä½†å¯èƒ½ä¸å®Œæ•´
                    const ip = endpointInfo.ip || 'N/A';
                    const port = endpointInfo.port || 'N/A';
                    endpointHtml += `${endpointInfo.protocol || 'http'}://${ip}:${port}`;
                    if (endpointInfo.nodeId) {
                        endpointHtml += ` | <strong>èŠ‚ç‚¹:</strong> ${endpointInfo.nodeId}`;
                    }
                    if (endpointInfo.instanceId) {
                        endpointHtml += ` | <strong>å®ä¾‹:</strong> ${endpointInfo.instanceId}`;
                    }
                    endpointHtml += ' <span style="color: #f59e0b;">(éƒ¨åˆ†ä¿¡æ¯)</span>';
                } else {
                    // æ²¡æœ‰æœ‰æ•ˆçš„ç«¯ç‚¹ä¿¡æ¯ï¼Œä¸æ˜¾ç¤ºç«¯ç‚¹ä¿¡æ¯
                    // ä½†ä¸ returnï¼Œç»§ç»­æ˜¾ç¤ºç»“æœ
                }
                
                if (endpointHtml !== '<strong>æœåŠ¡åœ°å€:</strong> ') {
                    endpointDiv.innerHTML = endpointHtml;
                    stepDiv.appendChild(endpointDiv);
                }
            }

            if (result) {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'step-result';
                resultDiv.textContent = JSON.stringify(result, null, 2);
                stepDiv.appendChild(resultDiv);
            }
        }

        function displayResults(result) {
            const summaryDiv = document.getElementById('resultSummary');
            const contentDiv = document.getElementById('resultContent');
            
            summaryDiv.style.display = 'block';
            
            let html = '';
            
            // ç¡®ä¿ result.results å­˜åœ¨
            const results = result.results || {};
            
            if (results.route_plan) {
                html += '<div class="result-item">';
                html += '<strong>èˆªè·¯è§„åˆ’:</strong> ';
                if (results.route_plan.success) {
                    html += `æˆåŠŸï¼Œç”Ÿæˆ ${(results.route_plan.route || []).length} ä¸ªèˆªç‚¹`;
                } else {
                    html += `å¤±è´¥: ${results.route_plan.error || 'æœªçŸ¥é”™è¯¯'}`;
                }
                html += '</div>';
            }

            if (results.navi_control) {
                html += '<div class="result-item">';
                html += '<strong>èˆªæ§å¯åŠ¨:</strong> ';
                if (results.navi_control.success) {
                    html += results.navi_control.message || 'æˆåŠŸ';
                } else {
                    html += `å¤±è´¥: ${results.navi_control.error || 'æœªçŸ¥é”™è¯¯'}`;
                }
                html += '</div>';
            }

            if (results.sonar) {
                html += '<div class="result-item">';
                html += '<strong>å£°çº³æ¢æµ‹:</strong> ';
                if (results.sonar.success) {
                    html += `æ£€æµ‹åˆ° ${results.sonar.target_count || 0} ä¸ªç›®æ ‡`;
                    if (results.sonar.targets && results.sonar.targets.length > 0) {
                        html += '<div class="target-list">';
                        results.sonar.targets.forEach((target, index) => {
                            html += `<div class="target-item">`;
                            html += `ç›®æ ‡ ${target.id || (index + 1)}: `;
                            // åªæ˜¾ç¤ºå£°çº³æ¢æµ‹ä¿¡æ¯ï¼ˆä½ç½®ã€è·ç¦»ã€å›¾åƒè·¯å¾„ï¼‰
                            html += `ä½ç½®: (${target.longitude.toFixed(6)}, ${target.latitude.toFixed(6)}) `;
                            html += `è·ç¦»: ${target.distance || 0}m`;
                            if (target.image_path) {
                                html += ` | å›¾åƒ: ${target.image_path}`;
                            }
                            html += `</div>`;
                        });
                        html += '</div>';
                    }
                } else {
                    html += `å¤±è´¥: ${results.sonar.error || 'æœªçŸ¥é”™è¯¯'}`;
                }
                html += '</div>';
            }
            
            // æ˜¾ç¤ºç›®æ ‡è¯†åˆ«ç»“æœ
            if (results.target_recognize && results.target_recognize.length > 0) {
                html += '<div class="result-item">';
                html += '<strong>ç›®æ ‡è¯†åˆ«:</strong> ';
                const successCount = results.target_recognize.filter(r => r && r.success).length;
                html += `æˆåŠŸè¯†åˆ« ${successCount}/${results.target_recognize.length} ä¸ªç›®æ ‡`;
                
                // æ˜¾ç¤ºæ¯ä¸ªç›®æ ‡çš„è¯†åˆ«ç»“æœ
                if (results.sonar && results.sonar.targets && results.sonar.targets.length > 0) {
                    html += '<div class="target-list">';
                    results.sonar.targets.forEach((target, index) => {
                        const imagePath = target.image_path;
                        if (imagePath) {
                            const recognizeResult = results.target_recognize.find(r => r && r.image_path === imagePath);
                            if (recognizeResult && recognizeResult.success) {
                                html += `<div class="target-item">`;
                                html += `ç›®æ ‡ ${target.id || (index + 1)}: `;
                                html += `${recognizeResult.target_type || 'æœªçŸ¥'} (${recognizeResult.size || 'æœªçŸ¥'}) `;
                                html += `ä½ç½®: (${target.longitude.toFixed(6)}, ${target.latitude.toFixed(6)}) `;
                                html += `ç½®ä¿¡åº¦: ${((recognizeResult.confidence || 0) * 100).toFixed(1)}% `;
                                if (imagePath) {
                                    html += ` | å›¾åƒ: ${imagePath}`;
                                }
                                html += `</div>`;
                            }
                        }
                    });
                    html += '</div>';
                }
                html += '</div>';
            }
            
            // æ˜¾ç¤ºç›®æ ‡æ‰“å‡»ç»“æœ
            if (results.target_hit && results.target_hit.length > 0) {
                html += '<div class="result-item">';
                html += '<strong>ç›®æ ‡æ‰“å‡»:</strong> ';
                const successCount = results.target_hit.filter(r => r && r.success).length;
                html += `æˆåŠŸæ‰“å‡» ${successCount}/${results.target_hit.length} ä¸ªç›®æ ‡`;
                
                // æ˜¾ç¤ºæ¯ä¸ªç›®æ ‡çš„æ‰“å‡»ç»“æœ
                if (successCount > 0) {
                    html += '<div class="target-list">';
                    results.target_hit.forEach((hit, index) => {
                        if (hit && hit.success) {
                            html += `<div class="target-item">`;
                            html += `ç›®æ ‡ ${hit.target_id || (index + 1)}: `;
                            html += `${hit.status || 'å·²æ‰“å‡»'} `;
                            html += `ä½ç½®: (${hit.longitude?.toFixed(6) || 'N/A'}, ${hit.latitude?.toFixed(6) || 'N/A'}) `;
                            html += `æŸä¼¤: ${hit.damage || 'N/A'}`;
                            if (hit.message) {
                                html += ` | ${hit.message}`;
                            }
                            html += `</div>`;
                        }
                    });
                    html += '</div>';
                }
                html += '</div>';
            }

            if (result.workflow && result.workflow.total_time) {
                html += `<div class="result-item"><strong>æ€»è€—æ—¶:</strong> ${result.workflow.total_time.toFixed(2)} ç§’</div>`;
            }

            contentDiv.innerHTML = html;
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœåŠ¡çŠ¶æ€
        checkServiceStatus();
        setInterval(checkServiceStatus, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
    </script>
</body>
</html>

