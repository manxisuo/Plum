# Protoå®šä¹‰å’Œç¼–è¯‘

## ğŸ“ ç›®å½•ç»“æ„

```
proto/
â”œâ”€â”€ task_service.proto    # gRPCæœåŠ¡å®šä¹‰ï¼ˆæºæ–‡ä»¶ï¼‰
â”œâ”€â”€ generate.sh           # è‡ªåŠ¨ç¼–è¯‘è„šæœ¬
â””â”€â”€ README.md            # æœ¬æ–‡æ¡£

ç”Ÿæˆä»£ç ä½ç½®ï¼š
â”œâ”€â”€ controller/plum/proto/         # Goç”Ÿæˆä»£ç 
â”‚   â”œâ”€â”€ task_service.pb.go
â”‚   â””â”€â”€ task_service_grpc.pb.go
â””â”€â”€ sdk/cpp/grpc/proto/            # C++ç”Ÿæˆä»£ç 
    â”œâ”€â”€ task_service.pb.h
    â”œâ”€â”€ task_service.pb.cc
    â”œâ”€â”€ task_service.grpc.pb.h
    â””â”€â”€ task_service.grpc.pb.cc
```

## ğŸ”¨ ç¼–è¯‘Proto

### ä½¿ç”¨Makefile
```bash
# é¡¶å±‚ç›®å½•
make proto         # ç”Ÿæˆæ‰€æœ‰protoä»£ç 
make proto-clean   # æ¸…ç†ç”Ÿæˆä»£ç 

# æˆ–åœ¨protoç›®å½•
cd proto
make all           # ç”Ÿæˆæ‰€æœ‰ä»£ç 
make generate-go   # åªç”ŸæˆGo
make generate-cpp  # åªç”ŸæˆC++
make clean         # æ¸…ç†
```

### æ–¹æ³•3ï¼šæ‰‹åŠ¨ç¼–è¯‘

#### Goä»£ç 
```bash
cd /home/stone/code/Plum
protoc --go_out=./controller --go_opt=paths=source_relative \
       --go-grpc_out=./controller --go-grpc_opt=paths=source_relative \
       proto/task_service.proto
```

#### C++ä»£ç 
```bash
cd /home/stone/code/Plum
protoc --cpp_out=./sdk/cpp/grpc/proto \
       --grpc_out=./sdk/cpp/grpc/proto \
       --plugin=protoc-gen-grpc=$(which grpc_cpp_plugin) \
       proto/task_service.proto
```

## ğŸ“‹ ä¾èµ–è¦æ±‚

### åŸºç¡€å·¥å…·
```bash
# å®‰è£…protobufç¼–è¯‘å™¨
sudo apt install protobuf-compiler
```

### Goæ’ä»¶ï¼ˆè‡ªåŠ¨å®‰è£…ï¼‰
```bash
go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
```

### C++æ’ä»¶
```bash
sudo apt install libgrpc++-dev protobuf-compiler-grpc
```

## ğŸ”„ å·¥ä½œæµç¨‹

### ä¿®æ”¹protoåçš„æ­¥éª¤

1. **ç¼–è¾‘protoæ–‡ä»¶**
   ```bash
   vim proto/task_service.proto
   ```

2. **ç”Ÿæˆä»£ç **
   ```bash
   make proto
   ```

3. **é‡æ–°ç¼–è¯‘ä½¿ç”¨æ–¹**
   ```bash
   # Goï¼ˆControllerï¼‰
   make controller
   
   # C++ï¼ˆSDKï¼‰
   make sdk_cpp
   ```

## ğŸ“ å½“å‰Protoå®šä¹‰

### TaskService
- `ExecuteTask` - æ‰§è¡Œä»»åŠ¡
- `HealthCheck` - å¥åº·æ£€æŸ¥

### æ¶ˆæ¯ç±»å‹
- `TaskRequest` - ä»»åŠ¡è¯·æ±‚
- `TaskResponse` - ä»»åŠ¡å“åº”
- `HealthRequest` - å¥åº·æ£€æŸ¥è¯·æ±‚
- `HealthResponse` - å¥åº·æ£€æŸ¥å“åº”

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### Controller (Go client)
```go
import pb "plum/controller/plum/proto"

conn, _ := grpc.Dial(address)
client := pb.NewTaskServiceClient(conn)
resp, _ := client.ExecuteTask(ctx, &pb.TaskRequest{
    TaskId:  "task-123",
    Name:    "echo",
    Payload: `{"msg":"hello"}`,
})
```

### C++ Worker (gRPC server)
```cpp
#include "proto/task_service.grpc.pb.h"

class TaskServiceImpl : public TaskService::Service {
    Status ExecuteTask(ServerContext* ctx, 
                       const TaskRequest* req,
                       TaskResponse* resp) override {
        // æ‰§è¡Œä»»åŠ¡é€»è¾‘
        resp->set_result("done");
        return Status::OK;
    }
};
```

## ğŸ“Š ç”Ÿæˆä»£ç å¤§å°

| æ–‡ä»¶ | å¤§å° | è¯´æ˜ |
|------|------|------|
| task_service.pb.go | ~10KB | Goæ¶ˆæ¯ç±»å‹ |
| task_service_grpc.pb.go | ~8KB | Go gRPCæœåŠ¡ |
| task_service.pb.{h,cc} | ~15KB | C++æ¶ˆæ¯ç±»å‹ |
| task_service.grpc.pb.{h,cc} | ~12KB | C++ gRPCæœåŠ¡ |

## âš ï¸ æ³¨æ„äº‹é¡¹

### ä¸è¦æ‰‹åŠ¨ç¼–è¾‘ç”Ÿæˆçš„ä»£ç 
ç”Ÿæˆçš„ä»£ç æ–‡ä»¶å¼€å¤´éƒ½æœ‰ï¼š
```
// Code generated by protoc-gen-go. DO NOT EDIT.
```

### ç”Ÿæˆä»£ç ä¸æäº¤åˆ°Git

**ç­–ç•¥**ï¼šç”Ÿæˆçš„ä»£ç å·²åœ¨`.gitignore`ä¸­ï¼Œä¸ä¼šæäº¤åˆ°Gitã€‚

**åŸå› **ï¼š
- protoæ–‡ä»¶æ˜¯å”¯ä¸€æºï¼Œç”Ÿæˆä»£ç å¯éšæ—¶é‡å»º
- é¿å…åˆå¹¶å†²çªå’Œä»“åº“è†¨èƒ€
- ä¿æŒGitå†å²å¹²å‡€

**å…‹éš†é¡¹ç›®å**ï¼š
```bash
git clone <repo>
cd Plum
make proto      # ç”Ÿæˆprotoä»£ç 
make controller # ç¼–è¯‘Controller
make sdk_cpp    # ç¼–è¯‘C++ SDK
```

**æ¸…ç†å†å²é—ç•™**ï¼ˆå¦‚æœpbæ–‡ä»¶å·²æäº¤ï¼‰ï¼š
```bash
git rm --cached -r controller/plum/proto/*.pb.go
git rm --cached -r sdk/cpp/grpc/proto/*.pb.*
git commit -m "chore: remove generated proto files"
```

## ğŸš€ å¿«é€Ÿå‚è€ƒ

```bash
# ä¿®æ”¹protoæ–‡ä»¶å
make proto              # ç”Ÿæˆæ‰€æœ‰ä»£ç 
make controller         # é‡æ–°ç¼–è¯‘Controller
make sdk_cpp            # é‡æ–°ç¼–è¯‘C++ SDK

# éªŒè¯ç”Ÿæˆç»“æœ
ls -lh controller/plum/proto/
ls -lh sdk/cpp/grpc/proto/
```

## ğŸ”® æœªæ¥æ‰©å±•

å½“æ·»åŠ æ–°çš„protoæ–‡ä»¶æ—¶ï¼š
1. åœ¨proto/ç›®å½•åˆ›å»ºæ–°çš„.protoæ–‡ä»¶
2. åœ¨generate.shä¸­æ·»åŠ ç¼–è¯‘å‘½ä»¤
3. è¿è¡Œ`make proto`ç”Ÿæˆä»£ç 

---

**æç¤º**ï¼šprotoå®šä¹‰æ˜¯Controllerå’ŒWorkerä¹‹é—´çš„**æ¥å£å¥‘çº¦**ï¼Œä¿®æ”¹æ—¶éœ€è¦ä¿è¯å…¼å®¹æ€§ã€‚

