# Proto定义和编译

## 📁 目录结构

```
proto/
├── task_service.proto    # gRPC服务定义（源文件）
├── generate.sh           # 自动编译脚本
└── README.md            # 本文档

生成代码位置：
├── controller/plum/proto/         # Go生成代码
│   ├── task_service.pb.go
│   └── task_service_grpc.pb.go
└── sdk/cpp/grpc/proto/            # C++生成代码
    ├── task_service.pb.h
    ├── task_service.pb.cc
    ├── task_service.grpc.pb.h
    └── task_service.grpc.pb.cc
```

## 🔨 编译Proto

### 使用Makefile
```bash
# 顶层目录
make proto         # 生成所有proto代码
make proto-clean   # 清理生成代码

# 或在proto目录
cd proto
make all           # 生成所有代码
make generate-go   # 只生成Go
make generate-cpp  # 只生成C++
make clean         # 清理
```

### 方法3：手动编译

#### Go代码
```bash
cd /home/stone/code/Plum
protoc --go_out=./controller --go_opt=paths=source_relative \
       --go-grpc_out=./controller --go-grpc_opt=paths=source_relative \
       proto/task_service.proto
```

#### C++代码
```bash
cd /home/stone/code/Plum
protoc --cpp_out=./sdk/cpp/grpc/proto \
       --grpc_out=./sdk/cpp/grpc/proto \
       --plugin=protoc-gen-grpc=$(which grpc_cpp_plugin) \
       proto/task_service.proto
```

## 📋 依赖要求

### 基础工具
```bash
# 安装protobuf编译器
sudo apt install protobuf-compiler
```

### Go插件（自动安装）
```bash
go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
```

### C++插件
```bash
sudo apt install libgrpc++-dev protobuf-compiler-grpc
```

## 🔄 工作流程

### 修改proto后的步骤

1. **编辑proto文件**
   ```bash
   vim proto/task_service.proto
   ```

2. **生成代码**
   ```bash
   make proto
   ```

3. **重新编译使用方**
   ```bash
   # Go（Controller）
   make controller
   
   # C++（SDK）
   make sdk_cpp
   ```

## 📝 当前Proto定义

### TaskService
- `ExecuteTask` - 执行任务
- `HealthCheck` - 健康检查

### 消息类型
- `TaskRequest` - 任务请求
- `TaskResponse` - 任务响应
- `HealthRequest` - 健康检查请求
- `HealthResponse` - 健康检查响应

## 🎯 使用场景

### Controller (Go client)
```go
import pb "plum/controller/plum/proto"

conn, _ := grpc.Dial(address)
client := pb.NewTaskServiceClient(conn)
resp, _ := client.ExecuteTask(ctx, &pb.TaskRequest{
    TaskId:  "task-123",
    Name:    "echo",
    Payload: `{"msg":"hello"}`,
})
```

### C++ Worker (gRPC server)
```cpp
#include "proto/task_service.grpc.pb.h"

class TaskServiceImpl : public TaskService::Service {
    Status ExecuteTask(ServerContext* ctx, 
                       const TaskRequest* req,
                       TaskResponse* resp) override {
        // 执行任务逻辑
        resp->set_result("done");
        return Status::OK;
    }
};
```

## 📊 生成代码大小

| 文件 | 大小 | 说明 |
|------|------|------|
| task_service.pb.go | ~10KB | Go消息类型 |
| task_service_grpc.pb.go | ~8KB | Go gRPC服务 |
| task_service.pb.{h,cc} | ~15KB | C++消息类型 |
| task_service.grpc.pb.{h,cc} | ~12KB | C++ gRPC服务 |

## ⚠️ 注意事项

### 不要手动编辑生成的代码
生成的代码文件开头都有：
```
// Code generated by protoc-gen-go. DO NOT EDIT.
```

### 生成代码不提交到Git

**策略**：生成的代码已在`.gitignore`中，不会提交到Git。

**原因**：
- proto文件是唯一源，生成代码可随时重建
- 避免合并冲突和仓库膨胀
- 保持Git历史干净

**克隆项目后**：
```bash
git clone <repo>
cd Plum
make proto      # 生成proto代码
make controller # 编译Controller
make sdk_cpp    # 编译C++ SDK
```

**清理历史遗留**（如果pb文件已提交）：
```bash
git rm --cached -r controller/plum/proto/*.pb.go
git rm --cached -r sdk/cpp/grpc/proto/*.pb.*
git commit -m "chore: remove generated proto files"
```

## 🚀 快速参考

```bash
# 修改proto文件后
make proto              # 生成所有代码
make controller         # 重新编译Controller
make sdk_cpp            # 重新编译C++ SDK

# 验证生成结果
ls -lh controller/plum/proto/
ls -lh sdk/cpp/grpc/proto/
```

## 🔮 未来扩展

当添加新的proto文件时：
1. 在proto/目录创建新的.proto文件
2. 在generate.sh中添加编译命令
3. 运行`make proto`生成代码

---

**提示**：proto定义是Controller和Worker之间的**接口契约**，修改时需要保证兼容性。

