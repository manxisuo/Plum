SHELL := /bin/bash

# Goå·¥å…·é“¾è·¯å¾„
GOBIN := $(shell go env GOPATH)/bin

.PHONY: all clean generate-go generate-cpp

all: generate-go generate-cpp
	@echo "âœ… Proto generation complete"

# ç”ŸæˆGoä»£ç 
generate-go:
	@echo "ðŸ“¦ Generating Go code..."
	@command -v protoc > /dev/null 2>&1 || { echo "âŒ protoc not found"; exit 1; }
	@test -f $(GOBIN)/protoc-gen-go || { echo "âŒ protoc-gen-go not found. Run: go install google.golang.org/protobuf/cmd/protoc-gen-go@latest"; exit 1; }
	@test -f $(GOBIN)/protoc-gen-go-grpc || { echo "âŒ protoc-gen-go-grpc not found. Run: go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest"; exit 1; }
	@cd .. && protoc -I=proto \
		--go_out=. --go_opt=module=github.com/manxisuo/plum \
		--go-grpc_out=. --go-grpc_opt=module=github.com/manxisuo/plum \
		--plugin=protoc-gen-go=$(GOBIN)/protoc-gen-go \
		--plugin=protoc-gen-go-grpc=$(GOBIN)/protoc-gen-go-grpc \
		proto/task_service.proto
	@echo "âœ… Go: controller/proto/"

# ç”ŸæˆC++ä»£ç ï¼ˆåœ¨çˆ¶ç›®å½•æ‰§è¡Œï¼‰
generate-cpp:
	@if command -v grpc_cpp_plugin > /dev/null 2>&1; then \
		echo "ðŸ“¦ Generating C++ code..."; \
		mkdir -p ../sdk/cpp/grpc/proto; \
		cd .. && protoc -I=proto \
			--cpp_out=./sdk/cpp/grpc/proto \
			--grpc_out=./sdk/cpp/grpc/proto \
			--plugin=protoc-gen-grpc=$$(which grpc_cpp_plugin) \
			proto/task_service.proto; \
		echo "âœ… C++: sdk/cpp/grpc/proto/"; \
	else \
		echo "âš ï¸  grpc_cpp_plugin not found, C++ skipped"; \
		echo "   Install: sudo apt install libgrpc++-dev protobuf-compiler-grpc"; \
	fi

# æ¸…ç†ç”Ÿæˆçš„ä»£ç 
clean:
	@echo "Cleaning generated proto files..."
	@rm -f ../controller/proto/*.pb.go
	@rm -f ../controller/plum/proto/*.pb.go 2>/dev/null || true
	@rm -f ../controller/*.pb.go 2>/dev/null || true
	@rm -rf ../plum 2>/dev/null || true
	@rm -f ../sdk/cpp/grpc/proto/*.pb.{h,cc}
	@rm -rf ../sdk/cpp/grpc/proto/proto 2>/dev/null || true
	@echo "âœ… Cleaned"

