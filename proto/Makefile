SHELL := /bin/bash

# Goå·¥å…·é“¾è·¯å¾„
GOBIN := $(shell go env GOPATH)/bin
PROTOC_GEN_GO := $(GOBIN)/protoc-gen-go
PROTOC_GEN_GO_GRPC := $(GOBIN)/protoc-gen-go-grpc

.PHONY: all clean check-tools

all: check-tools generate-go generate-cpp
	@echo "âœ… Proto generation complete"

# æ£€æŸ¥protocæ˜¯å¦å®‰è£…
check-tools:
	@command -v protoc > /dev/null 2>&1 || { echo "âŒ protoc not found. Install: sudo apt install protobuf-compiler"; exit 1; }
	@echo "âœ“ protoc version: $$(protoc --version)"

# æ£€æŸ¥å¹¶å®‰è£…Goæ’ä»¶
$(PROTOC_GEN_GO):
	@echo "â†’ Installing protoc-gen-go..."
	@go install google.golang.org/protobuf/cmd/protoc-gen-go@latest

$(PROTOC_GEN_GO_GRPC):
	@echo "â†’ Installing protoc-gen-go-grpc..."
	@go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

# ç”ŸæˆGoä»£ç 
generate-go: $(PROTOC_GEN_GO) $(PROTOC_GEN_GO_GRPC)
	@echo "ðŸ“¦ Generating Go code..."
	@cd .. && protoc -I=proto \
		--go_out=. --go_opt=module=github.com/manxisuo/Plum/controller \
		--go-grpc_out=. --go-grpc_opt=module=github.com/manxisuo/Plum/controller \
		--plugin=protoc-gen-go=$(PROTOC_GEN_GO) \
		--plugin=protoc-gen-go-grpc=$(PROTOC_GEN_GO_GRPC) \
		proto/task_service.proto
	@echo "âœ… Go: controller/plum/proto/"

# ç”ŸæˆC++ä»£ç ï¼ˆåœ¨çˆ¶ç›®å½•æ‰§è¡Œï¼‰
generate-cpp:
	@if command -v grpc_cpp_plugin > /dev/null 2>&1; then \
		echo "ðŸ“¦ Generating C++ code..."; \
		mkdir -p ../sdk/cpp/grpc/proto; \
		cd .. && protoc -I=proto \
			--cpp_out=./sdk/cpp/grpc/proto \
			--grpc_out=./sdk/cpp/grpc/proto \
			--plugin=protoc-gen-grpc=$$(which grpc_cpp_plugin) \
			proto/task_service.proto; \
		echo "âœ… C++: sdk/cpp/grpc/proto/"; \
	else \
		echo "âš ï¸  grpc_cpp_plugin not found, C++ skipped"; \
		echo "   Install: sudo apt install libgrpc++-dev protobuf-compiler-grpc"; \
	fi

# æ¸…ç†ç”Ÿæˆçš„ä»£ç 
clean:
	@echo "Cleaning generated proto files..."
	@rm -f ../controller/plum/proto/*.pb.go
	@rm -f ../controller/*.pb.go 2>/dev/null || true
	@rm -f ../sdk/cpp/grpc/proto/*.pb.{h,cc}
	@rm -rf ../sdk/cpp/grpc/proto/proto 2>/dev/null || true
	@echo "âœ… Cleaned"

