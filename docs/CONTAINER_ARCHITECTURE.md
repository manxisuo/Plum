# Plum å®¹å™¨åŒ–æ¶æ„åˆ†æ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**é‡è¦ï¼šä¿ç•™ç°æœ‰éå®¹å™¨åŒ–éƒ¨ç½²èƒ½åŠ›**
- âœ… Agentã€Controller å’Œåº”ç”¨éƒ½å¯ä»¥ä½œä¸ºè£¸åº”ç”¨è¿è¡Œï¼ˆé»˜è®¤æ¨¡å¼ï¼‰
- âœ… å®¹å™¨åŒ–éƒ¨ç½²æ˜¯**å¯é€‰çš„å¢å¼ºåŠŸèƒ½**ï¼Œä¸æ˜¯æ›¿æ¢
- âœ… ä¸¤ç§éƒ¨ç½²æ–¹å¼å¯ä»¥å¹¶å­˜ï¼Œé€šè¿‡é…ç½®é€‰æ‹©
- âœ… å‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰éƒ¨ç½²

---

## ğŸ“‹ å½“å‰æ¶æ„åˆ†æ

### ç°çŠ¶
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   plum-agent å®¹å™¨                   â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  plum-agent è¿›ç¨‹              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  App1 è¿›ç¨‹ (fork/exec)       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  App2 è¿›ç¨‹ (fork/exec)       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚  /app/data/                        â”‚
â”‚    â”œâ”€â”€ instance1/app/              â”‚
â”‚    â””â”€â”€ instance2/app/              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é—®é¢˜åˆ†æ

| é—®é¢˜ | å½±å“ | ä¸¥é‡ç¨‹åº¦ |
|------|------|----------|
| **èµ„æºéš”ç¦»ä¸è¶³** | æ‰€æœ‰åº”ç”¨å…±äº«Agentå®¹å™¨çš„CPUã€å†…å­˜é™åˆ¶ | âš ï¸ é«˜ |
| **ä¾èµ–å†²çª** | ä¸åŒåº”ç”¨å¯èƒ½éœ€è¦çš„è¿è¡Œæ—¶ç¯å¢ƒä¸åŒï¼ˆPythonç‰ˆæœ¬ã€Nodeç‰ˆæœ¬ç­‰ï¼‰ | âš ï¸ é«˜ |
| **å®‰å…¨æ€§** | åº”ç”¨å¯ä»¥è®¿é—®Agentå®¹å™¨çš„æ‰€æœ‰ç¯å¢ƒå˜é‡å’Œæ–‡ä»¶ç³»ç»Ÿ | âš ï¸ é«˜ |
| **è°ƒè¯•å›°éš¾** | å¤šä¸ªåº”ç”¨çš„æ—¥å¿—æ··åˆåœ¨Agentå®¹å™¨ä¸­ | âš ï¸ ä¸­ |
| **èµ„æºç›‘æ§** | æ— æ³•å•ç‹¬ç›‘æ§æ¯ä¸ªåº”ç”¨çš„èµ„æºä½¿ç”¨æƒ…å†µ | âš ï¸ ä¸­ |
| **å®¹å™¨é‡å¯** | Agentå®¹å™¨é‡å¯ä¼šå½±å“æ‰€æœ‰è¿è¡Œä¸­çš„åº”ç”¨ | âš ï¸ é«˜ |
| **ä¸ç¬¦åˆäº‘åŸç”Ÿ** | è¿èƒŒ"ä¸€ä¸ªå®¹å™¨ä¸€ä¸ªåº”ç”¨"çš„æœ€ä½³å®è·µ | âš ï¸ ä¸­ |

---

## âœ… æ¨èæ¶æ„ï¼šå®¹å™¨éš”ç¦»æ–¹æ¡ˆ

### è®¾è®¡å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   plum-agent å®¹å™¨                   â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  plum-agent è¿›ç¨‹              â”‚ â”‚
â”‚  â”‚  (é€šè¿‡Docker APIç®¡ç†å®¹å™¨)     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚           â”‚
         â”‚           â”‚ Docker API
         â”‚           â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚ App1    â”‚  â”‚ App2   â”‚
    â”‚ å®¹å™¨    â”‚  â”‚ å®¹å™¨   â”‚
    â”‚         â”‚  â”‚        â”‚
    â”‚ ç‹¬ç«‹ç¯å¢ƒ â”‚  â”‚ ç‹¬ç«‹ç¯å¢ƒâ”‚
    â”‚ èµ„æºé™åˆ¶ â”‚  â”‚ èµ„æºé™åˆ¶â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¼˜åŠ¿

1. **èµ„æºéš”ç¦»**
   - æ¯ä¸ªåº”ç”¨æœ‰ç‹¬ç«‹çš„CPUã€å†…å­˜é™åˆ¶
   - å¯ä»¥ç²¾ç¡®æ§åˆ¶æ¯ä¸ªåº”ç”¨çš„èµ„æºé…é¢

2. **ç¯å¢ƒéš”ç¦»**
   - æ¯ä¸ªåº”ç”¨å¯ä»¥æœ‰ä¸åŒçš„åŸºç¡€é•œåƒ
   - é¿å…ä¾èµ–å†²çªï¼ˆå¦‚ä¸åŒçš„Python/Nodeç‰ˆæœ¬ï¼‰

3. **å®‰å…¨æ€§**
   - åº”ç”¨æ— æ³•è®¿é—®Agentå®¹å™¨
   - å¯ä»¥è®¾ç½®æ›´ç»†ç²’åº¦çš„æƒé™æ§åˆ¶

4. **å¯è§‚æµ‹æ€§**
   - æ¯ä¸ªå®¹å™¨ç‹¬ç«‹çš„æ—¥å¿—
   - ç‹¬ç«‹çš„å¥åº·æ£€æŸ¥
   - ç‹¬ç«‹çš„èµ„æºç›‘æ§

5. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**
   - å®¹å™¨é‡å¯ä¸å½±å“Agent
   - å¯ä»¥ç‹¬ç«‹æ›´æ–°ã€å›æ»šåº”ç”¨

6. **ç¬¦åˆäº‘åŸç”Ÿæœ€ä½³å®è·µ**
   - éµå¾ª"ä¸€ä¸ªå®¹å™¨ä¸€ä¸ªåº”ç”¨"åŸåˆ™
   - æ›´å¥½çš„å¯ç§»æ¤æ€§å’Œå¯æ‰©å±•æ€§

---

## ğŸ”§ å®ç°æ–¹æ¡ˆï¼šåŒæ¨¡å¼æ¶æ„

### è®¾è®¡åŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Plum Agent                      â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   App Manager Interface          â”‚  â”‚
â”‚  â”‚   (ç»Ÿä¸€çš„åº”ç”¨ç®¡ç†æ¥å£)            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚             â”‚               â”‚            â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚ Process Mode  â”‚  â”‚ Docker Mode  â”‚ â”‚
â”‚    â”‚ (é»˜è®¤æ¨¡å¼)    â”‚  â”‚ (å¯é€‰æ¨¡å¼)   â”‚ â”‚
â”‚    â”‚               â”‚  â”‚              â”‚ â”‚
â”‚    â”‚ fork/exec     â”‚  â”‚ docker run    â”‚ â”‚
â”‚    â”‚ è£¸è¿›ç¨‹è¿è¡Œ    â”‚  â”‚ å®¹å™¨è¿è¡Œ      â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é…ç½®æ–¹å¼

é€šè¿‡ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶é€‰æ‹©è¿è¡Œæ¨¡å¼ï¼š

```bash
# æ–¹å¼1ï¼šç¯å¢ƒå˜é‡
AGENT_RUN_MODE=process    # é»˜è®¤ï¼šè¿›ç¨‹æ¨¡å¼
AGENT_RUN_MODE=docker     # å¯é€‰ï¼šå®¹å™¨æ¨¡å¼

# æ–¹å¼2ï¼šé…ç½®æ–‡ä»¶ï¼ˆ.envï¼‰
AGENT_RUN_MODE=process
```

### æ–¹æ¡ˆä¸€ï¼šAgentç›´æ¥ç®¡ç†Dockerå®¹å™¨ï¼ˆæ¨èï¼‰

#### æ¶æ„è®¾è®¡
```go
// Agentä½¿ç”¨Docker SDKåˆ›å»ºå’Œç®¡ç†åº”ç”¨å®¹å™¨
type DockerContainerManager struct {
    client *docker.Client
}

func (m *DockerContainerManager) StartApp(instanceID string, app AppConfig) error {
    // 1. ä¸‹è½½artifactåˆ°ä¸´æ—¶ç›®å½•
    // 2. è§£å‹åˆ°ä¸´æ—¶ç›®å½•
    // 3. åˆ›å»ºDockeré•œåƒï¼ˆæˆ–ä½¿ç”¨åŸºç¡€é•œåƒæŒ‚è½½å·ï¼‰
    // 4. è¿è¡Œå®¹å™¨
}
```

#### å®ç°è¦ç‚¹

1. **Agentå®¹å™¨é…ç½®**
   ```dockerfile
   # éœ€è¦æŒ‚è½½Docker socketï¼ˆæˆ–ä½¿ç”¨Docker-in-Dockerï¼‰
   volumes:
     - /var/run/docker.sock:/var/run/docker.sock  # Docker socket
     - app-volumes:/app/volumes                    # åº”ç”¨æ•°æ®å·
   ```

2. **åº”ç”¨å®¹å™¨åˆ›å»ºæµç¨‹**
   ```
   1. Agentä¸‹è½½artifact â†’ /tmp/{instanceID}.zip
   2. è§£å‹åˆ°æ•°æ®å· â†’ /app/volumes/{instanceID}/
   3. ä½¿ç”¨docker runåˆ›å»ºå®¹å™¨ï¼š
      docker run -d \
        --name plum-app-{instanceID} \
        --volume /app/volumes/{instanceID}:/app \
        --network plum-network \
        --memory=512m \
        --cpus=1.0 \
        base-image:tag \
        {startCmd}
   ```

3. **å®¹å™¨å‘½åè§„èŒƒ**
   - `plum-app-{instanceID}` - åº”ç”¨å®¹å™¨
   - `plum-agent-{nodeID}` - Agentå®¹å™¨

#### ä¼˜ç‚¹
- âœ… å®ç°ç®€å•ï¼ŒAgentç›´æ¥æ§åˆ¶
- âœ… å……åˆ†åˆ©ç”¨Dockerçš„åŸç”Ÿèƒ½åŠ›
- âœ… èµ„æºéš”ç¦»å’Œé™åˆ¶å®Œå–„

#### ç¼ºç‚¹
- âš ï¸ éœ€è¦æŒ‚è½½Docker socketï¼ˆå®‰å…¨è€ƒè™‘ï¼‰
- âš ï¸ Agentéœ€è¦Docker SDKä¾èµ–

---

### æ–¹æ¡ˆäºŒï¼šä½¿ç”¨Docker ComposeåŠ¨æ€ç®¡ç†ï¼ˆé€‚åˆå°è§„æ¨¡ï¼‰

#### æ¶æ„è®¾è®¡
```yaml
# åŠ¨æ€ç”Ÿæˆdocker-compose.ymlç‰‡æ®µ
services:
  plum-app-instance1:
    image: base-image:tag
    volumes:
      - app-instance1:/app
    command: ./start.sh
```

#### å®ç°è¦ç‚¹

1. Agentç”ŸæˆComposeé…ç½®ç‰‡æ®µ
2. ä½¿ç”¨`docker-compose up`å¯åŠ¨åº”ç”¨
3. ä½¿ç”¨`docker-compose down`åœæ­¢åº”ç”¨

#### ä¼˜ç‚¹
- âœ… å¯ä»¥åˆ©ç”¨Docker Composeçš„ç¼–æ’èƒ½åŠ›
- âœ… é…ç½®æ–‡ä»¶ä¾¿äºç®¡ç†

#### ç¼ºç‚¹
- âš ï¸ éœ€è¦æ–‡ä»¶ç³»ç»Ÿè®¿é—®æƒé™
- âš ï¸ åŠ¨æ€æ›´æ–°Composeæ–‡ä»¶å¯èƒ½å¤æ‚

---

### æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨Kubernetes Job/Podï¼ˆæœªæ¥æ‰©å±•ï¼‰

å¦‚æœæœªæ¥è¦æ”¯æŒKubernetesç¯å¢ƒï¼Œå¯ä»¥è€ƒè™‘ï¼š
- Agentä½œä¸ºOperatorè¿è¡Œ
- é€šè¿‡Kubernetes APIåˆ›å»ºJob/Pod
- æ›´å¥½çš„èµ„æºè°ƒåº¦å’Œé›†ç¾¤ç®¡ç†

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | å½“å‰æ–¹æ¡ˆ<br>(è¿›ç¨‹éš”ç¦») | æ–¹æ¡ˆä¸€<br>(Dockerå®¹å™¨) | æ–¹æ¡ˆäºŒ<br>(Compose) |
|------|---------------------|---------------------|-------------------|
| **å®ç°å¤æ‚åº¦** | â­ ç®€å• | â­â­â­ ä¸­ç­‰ | â­â­â­â­ è¾ƒå¤æ‚ |
| **èµ„æºéš”ç¦»** | âŒ æ—  | âœ… å®Œå–„ | âœ… å®Œå–„ |
| **ç¯å¢ƒéš”ç¦»** | âŒ æ—  | âœ… å®Œå–„ | âœ… å®Œå–„ |
| **å®‰å…¨æ€§** | âš ï¸ ä½ | âš ï¸ ä¸­ç­‰ | âœ… è¾ƒé«˜ |
| **å¯ç§»æ¤æ€§** | âŒ ä½ | âœ… é«˜ | âœ… é«˜ |
| **æ€§èƒ½å¼€é”€** | âœ… æœ€ä½ | âš ï¸ ä¸­ç­‰ | âš ï¸ ä¸­ç­‰ |
| **é€‚ç”¨åœºæ™¯** | å•æœºç®€å•éƒ¨ç½² | ç”Ÿäº§ç¯å¢ƒ | å¤æ‚ç¼–æ’ |

---

## ğŸ¯ æ¨èå®æ–½æ­¥éª¤

### é˜¶æ®µä¸€ï¼šåŸºç¡€å®ç°ï¼ˆæ–¹æ¡ˆä¸€ï¼‰

1. **ä¿®æ”¹Agentå®¹å™¨é…ç½®**
   ```yaml
   plum-agent:
     volumes:
       - /var/run/docker.sock:/var/run/docker.sock
       - app-data:/app/volumes
   ```

2. **æ·»åŠ Docker SDKä¾èµ–**
   ```go
   import "github.com/docker/docker/client"
   ```

3. **å®ç°å®¹å™¨ç®¡ç†å™¨**
   - åˆ›å»º`docker_manager.go`
   - å®ç°`CreateContainer()`, `StartContainer()`, `StopContainer()`
   - å®ç°`ListContainers()`, `GetContainerStatus()`

4. **ä¿®æ”¹Reconciler**
   - æ›¿æ¢`exec.Command`ä¸º`docker run`
   - å®ç°å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

### é˜¶æ®µäºŒï¼šå¢å¼ºåŠŸèƒ½

1. **èµ„æºé™åˆ¶é…ç½®**
   - ä»åº”ç”¨é…ç½®è¯»å–CPU/å†…å­˜é™åˆ¶
   - åº”ç”¨åˆ°Dockerå®¹å™¨

2. **ç½‘ç»œéš”ç¦»**
   - ä¸ºæ¯ä¸ªåº”ç”¨åˆ›å»ºç‹¬ç«‹ç½‘ç»œï¼ˆå¯é€‰ï¼‰
   - æˆ–ä½¿ç”¨Dockerç½‘ç»œç­–ç•¥

3. **æ—¥å¿—ç®¡ç†**
   - é…ç½®å®¹å™¨æ—¥å¿—é©±åŠ¨
   - ç»Ÿä¸€çš„æ—¥å¿—æ”¶é›†

4. **å¥åº·æ£€æŸ¥**
   - ä¸ºæ¯ä¸ªåº”ç”¨å®¹å™¨é…ç½®å¥åº·æ£€æŸ¥
   - é›†æˆåˆ°Agentçš„çŠ¶æ€æŠ¥å‘Š

### é˜¶æ®µä¸‰ï¼šé«˜çº§ç‰¹æ€§

1. **é•œåƒç®¡ç†**
   - æ”¯æŒè‡ªå®šä¹‰åŸºç¡€é•œåƒ
   - è‡ªåŠ¨æ„å»ºåº”ç”¨é•œåƒ

2. **æ•°æ®å·ç®¡ç†**
   - æŒä¹…åŒ–å­˜å‚¨
   - æ•°æ®å·ç”Ÿå‘½å‘¨æœŸç®¡ç†

3. **ç›‘æ§é›†æˆ**
   - Prometheus metrics
   - å®¹å™¨èµ„æºä½¿ç”¨ç›‘æ§

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å®‰å…¨é—®é¢˜

1. **Docker SocketæŒ‚è½½é£é™©**
   ```yaml
   # âš ï¸ éœ€è¦è¯„ä¼°å®‰å…¨é£é™©
   volumes:
     - /var/run/docker.sock:/var/run/docker.sock
   ```
   - Agentæ‹¥æœ‰å®Œæ•´çš„Dockeræ§åˆ¶æƒé™
   - å»ºè®®ï¼šä½¿ç”¨Dockerçš„RBACæˆ–Docker-in-Docker

2. **æƒé™æ§åˆ¶**
   - Agentå®¹å™¨éœ€è¦è¶³å¤Ÿçš„æƒé™åˆ›å»ºå®¹å™¨
   - å»ºè®®ï¼šä½¿ç”¨érootç”¨æˆ· + sudoï¼Œæˆ–ç»™äºˆå¿…è¦çš„Dockeræƒé™

### æ€§èƒ½è€ƒè™‘

1. **å®¹å™¨å¯åŠ¨å¼€é”€**
   - ç›¸æ¯”è¿›ç¨‹å¯åŠ¨ï¼Œå®¹å™¨å¯åŠ¨æœ‰é¢å¤–å¼€é”€ï¼ˆ~100-500msï¼‰
   - éœ€è¦è€ƒè™‘å†·å¯åŠ¨æ—¶é—´

2. **èµ„æºå¼€é”€**
   - æ¯ä¸ªå®¹å™¨æœ‰åŸºç¡€å†…å­˜å¼€é”€ï¼ˆ~10-50MBï¼‰
   - éœ€è¦è€ƒè™‘æ€»èµ„æºéœ€æ±‚

### å…¼å®¹æ€§

1. **ä¿æŒå‘åå…¼å®¹**
   - ä¿ç•™è¿›ç¨‹æ¨¡å¼ä½œä¸ºfallback
   - é€šè¿‡é…ç½®é€‰æ‹©è¿è¡Œæ¨¡å¼

2. **è¿ç§»ç­–ç•¥**
   - é€æ­¥è¿ç§»ç°æœ‰åº”ç”¨åˆ°å®¹å™¨æ¨¡å¼
   - æä¾›è¿ç§»å·¥å…·å’Œæ–‡æ¡£

---

## ğŸ“ ç¤ºä¾‹ä»£ç ç»“æ„

```
agent-go/
â”œâ”€â”€ reconciler.go          # ç°æœ‰ä»£ç ï¼ˆä¿ç•™ï¼Œé»˜è®¤ä½¿ç”¨ï¼‰
â”œâ”€â”€ app_manager.go         # æ–°å¢ï¼šç»Ÿä¸€åº”ç”¨ç®¡ç†æ¥å£
â”‚   â”œâ”€â”€ ProcessManager    # è¿›ç¨‹æ¨¡å¼å®ç°ï¼ˆç°æœ‰é€»è¾‘è¿ç§»ï¼‰
â”‚   â””â”€â”€ DockerManager     # å®¹å™¨æ¨¡å¼å®ç°ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ docker_manager.go      # æ–°å¢ï¼šDockerå®¹å™¨ç®¡ç†
â”œâ”€â”€ container_config.go     # æ–°å¢ï¼šå®¹å™¨é…ç½®
â””â”€â”€ manager_factory.go     # æ–°å¢ï¼šç®¡ç†å™¨å·¥å‚ï¼ˆæ ¹æ®é…ç½®é€‰æ‹©ï¼‰
```

### ä»£ç æ¥å£è®¾è®¡

```go
// app_manager.go
type AppManager interface {
    StartApp(instanceID string, app AppConfig) error
    StopApp(instanceID string) error
    GetStatus(instanceID string) (AppStatus, error)
    ListApps() ([]AppInfo, error)
}

// manager_factory.go
func NewAppManager(mode string, config ManagerConfig) (AppManager, error) {
    switch mode {
    case "docker":
        return NewDockerManager(config)
    case "process", "":  // é»˜è®¤æ¨¡å¼
        return NewProcessManager(config)
    default:
        return nil, fmt.Errorf("unknown mode: %s", mode)
    }
}
```

---

## âœ… ä¿ç•™ç°æœ‰éå®¹å™¨åŒ–éƒ¨ç½²èƒ½åŠ›

### å…¼å®¹æ€§ä¿è¯

1. **é»˜è®¤è¡Œä¸ºä¸å˜**
   ```bash
   # é»˜è®¤æ¨¡å¼ï¼šè¿›ç¨‹æ¨¡å¼ï¼ˆéå®¹å™¨åŒ–ï¼‰
   # ä¸è®¾ç½® AGENT_RUN_MODE æˆ–è®¾ç½®ä¸º process
   ./plum-agent
   # â†’ è¡Œä¸ºä¸å½“å‰å®Œå…¨ä¸€è‡´ï¼Œåº”ç”¨ç¨‹åºä»¥è¿›ç¨‹æ–¹å¼è¿è¡Œ
   ```

2. **ç°æœ‰éƒ¨ç½²ä¸å—å½±å“**
   - ç°æœ‰è£¸åº”ç”¨éƒ¨ç½²ï¼ˆsystemdã€ç›´æ¥è¿è¡Œï¼‰ç»§ç»­å·¥ä½œ
   - ä¸éœ€è¦ä¿®æ”¹ä»»ä½•é…ç½®æ–‡ä»¶
   - ä¸éœ€è¦é¢å¤–çš„ä¾èµ–

3. **å‘åå…¼å®¹**
   ```go
   // å¦‚æœæœªé…ç½® AGENT_RUN_MODEï¼Œé»˜è®¤ä½¿ç”¨è¿›ç¨‹æ¨¡å¼
   mode := getEnv("AGENT_RUN_MODE", "process")
   if mode == "" {
       mode = "process"  // é»˜è®¤å€¼
   }
   ```

### ä¸¤ç§æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | è¿›ç¨‹æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ | å®¹å™¨æ¨¡å¼ï¼ˆå¯é€‰ï¼‰ |
|------|----------------|----------------|
| **éƒ¨ç½²æ–¹å¼** | è£¸åº”ç”¨è¿è¡Œ | å®¹å™¨è¿è¡Œ |
| **èµ„æºéš”ç¦»** | å…±äº«Agentèµ„æº | ç‹¬ç«‹èµ„æºé™åˆ¶ |
| **ç¯å¢ƒéš”ç¦»** | å…±äº«Agentç¯å¢ƒ | ç‹¬ç«‹ç¯å¢ƒ |
| **ä¾èµ–ç®¡ç†** | éœ€è¦é¢„è£…ä¾èµ– | å®¹å™¨é•œåƒåŒ…å«ä¾èµ– |
| **å®‰å…¨æ€§** | ä¸­ç­‰ | é«˜ï¼ˆéš”ç¦»ï¼‰ |
| **å¯åŠ¨é€Ÿåº¦** | å¿«ï¼ˆè¿›ç¨‹ï¼‰ | ä¸­ç­‰ï¼ˆå®¹å™¨ï¼‰ |
| **èµ„æºå¼€é”€** | ä½ | ä¸­ç­‰ |
| **é€‚ç”¨åœºæ™¯** | å•æœºéƒ¨ç½²ã€ç®€å•ç¯å¢ƒ | ç”Ÿäº§ç¯å¢ƒã€å¤šç§Ÿæˆ· |
| **é…ç½®è¦æ±‚** | æ— ï¼ˆé»˜è®¤ï¼‰ | éœ€è¦Docker |

### ä½¿ç”¨åœºæ™¯

#### åœºæ™¯1ï¼šä¼ ç»Ÿè£¸åº”ç”¨éƒ¨ç½²ï¼ˆé»˜è®¤ï¼‰
```bash
# Agentã€Controllerã€Appéƒ½ä½œä¸ºç³»ç»ŸæœåŠ¡è¿è¡Œ
# systemdæœåŠ¡æˆ–ç›´æ¥è¿è¡Œ
./plum-agent              # Agent
./plum-controller          # Controller
./app/start.sh            # Appï¼ˆç”±Agentå¯åŠ¨ï¼‰
```

#### åœºæ™¯2ï¼šæ··åˆéƒ¨ç½²
```bash
# Controllerå’ŒAgentåœ¨å®¹å™¨ä¸­ï¼Œä½†åº”ç”¨ä»ç„¶æ˜¯è¿›ç¨‹
docker-compose up -d      # Controller + Agentå®¹å™¨åŒ–
# Agentå†…éƒ¨ä»ç„¶ä½¿ç”¨è¿›ç¨‹æ¨¡å¼è¿è¡Œåº”ç”¨
```

#### åœºæ™¯3ï¼šå®Œå…¨å®¹å™¨åŒ–ï¼ˆå¯é€‰ï¼‰
```bash
# æ‰€æœ‰ç»„ä»¶éƒ½å®¹å™¨åŒ–
AGENT_RUN_MODE=docker ./plum-agent  # Agentä½¿ç”¨å®¹å™¨æ¨¡å¼
# åº”ç”¨ä¹Ÿåœ¨ç‹¬ç«‹å®¹å™¨ä¸­è¿è¡Œ
```

### è¿ç§»ç­–ç•¥

#### é˜¶æ®µ1ï¼šä¿æŒç°çŠ¶ï¼ˆæ— éœ€æ”¹åŠ¨ï¼‰
- æ‰€æœ‰ç°æœ‰éƒ¨ç½²ç»§ç»­ä½¿ç”¨è¿›ç¨‹æ¨¡å¼
- ä»£ç å®Œå…¨å‘åå…¼å®¹
- ä¸å¼•å…¥ä»»ä½•ç ´åæ€§å˜æ›´

#### é˜¶æ®µ2ï¼šå¯é€‰å¯ç”¨å®¹å™¨æ¨¡å¼
```bash
# ä»…åœ¨éœ€è¦æ—¶å¯ç”¨å®¹å™¨æ¨¡å¼
AGENT_RUN_MODE=docker ./plum-agent
```

#### é˜¶æ®µ3ï¼šé€æ­¥è¿ç§»ï¼ˆå¯é€‰ï¼‰
- æ ¹æ®éœ€æ±‚ï¼Œéƒ¨åˆ†åº”ç”¨è¿ç§»åˆ°å®¹å™¨æ¨¡å¼
- å…¶ä»–åº”ç”¨ä¿æŒè¿›ç¨‹æ¨¡å¼
- ä¸¤ç§æ¨¡å¼å¯ä»¥å…±å­˜

### ä»£ç å®ç°ä¿è¯

```go
// reconciler.go ä¿æŒä¸å˜
// ä»…æ·»åŠ æ¨¡å¼é€‰æ‹©é€»è¾‘

func NewReconciler(baseDir string, http *HTTPClient, controller string) *Reconciler {
    // ... ç°æœ‰ä»£ç ä¸å˜ ...
    
    // æ–°å¢ï¼šæ ¹æ®é…ç½®é€‰æ‹©ç®¡ç†å™¨
    mode := getEnv("AGENT_RUN_MODE", "process")
    var appManager AppManager
    if mode == "docker" {
        appManager = NewDockerManager(config)
    } else {
        appManager = NewProcessManager(config)  // é»˜è®¤ï¼šç°æœ‰é€»è¾‘
    }
    
    // Reconcilerä½¿ç”¨ç»Ÿä¸€çš„AppManageræ¥å£
    return &Reconciler{
        // ... ç°æœ‰å­—æ®µ ...
        appManager: appManager,  // æ–°å¢å­—æ®µ
    }
}

// ensureRunning ä¿®æ”¹ä¸ºä½¿ç”¨ç®¡ç†å™¨
func (r *Reconciler) ensureRunning(a Assignment) {
    // æ—§ä»£ç ï¼ˆè¿›ç¨‹æ¨¡å¼ï¼‰ä¿ç•™ä¸ºProcessManagerå®ç°
    // æ–°ä»£ç ï¼ˆå®¹å™¨æ¨¡å¼ï¼‰åœ¨DockerManagerä¸­å®ç°
    return r.appManager.StartApp(a.InstanceID, a)
}
```

---

## ğŸ”„ å®æ–½ä¼˜å…ˆçº§

### é˜¶æ®µ0ï¼šå…¼å®¹æ€§ä¿è¯ï¼ˆå¿…é¡»ï¼‰
1. **ä¿æŒç°æœ‰ä»£ç ä¸å˜**
   - `reconciler.go` ç»§ç»­å·¥ä½œ
   - é»˜è®¤è¡Œä¸ºå®Œå…¨ä¸€è‡´
   - é›¶ç ´åæ€§å˜æ›´

2. **æ¥å£æŠ½è±¡**
   - å®šä¹‰ `AppManager` æ¥å£
   - ç°æœ‰é€»è¾‘å°è£…ä¸º `ProcessManager`
   - ä¿æŒæ¥å£å…¼å®¹

### é˜¶æ®µ1ï¼šP0ï¼ˆå¿…é¡»ï¼‰- å®¹å™¨åŠŸèƒ½
1. **åŸºç¡€å®¹å™¨ç®¡ç†åŠŸèƒ½**
   - åˆ›å»º/å¯åŠ¨/åœæ­¢å®¹å™¨
   - åŸºæœ¬çš„èµ„æºé™åˆ¶

2. **æ¨¡å¼é€‰æ‹©æœºåˆ¶**
   - ç¯å¢ƒå˜é‡é…ç½®
   - å·¥å‚æ¨¡å¼é€‰æ‹©ç®¡ç†å™¨

### é˜¶æ®µ2ï¼šP1ï¼ˆé‡è¦ï¼‰- å®‰å…¨å’Œéš”ç¦»
1. **Docker socketå®‰å…¨å¤„ç†**
2. **ç½‘ç»œéš”ç¦»**

### é˜¶æ®µ3ï¼šP2ï¼ˆå¢å¼ºï¼‰- ç›‘æ§å’Œæ—¥å¿—
1. **å®¹å™¨æ—¥å¿—æ”¶é›†**
2. **èµ„æºç›‘æ§**

### é˜¶æ®µ4ï¼šP3ï¼ˆå¯é€‰ï¼‰- é«˜çº§ç‰¹æ€§
1. **è‡ªå®šä¹‰é•œåƒ**
2. **æ•°æ®å·ç®¡ç†**

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Docker SDK for Go](https://pkg.go.dev/github.com/docker/docker/client)
- [Dockeræœ€ä½³å®è·µ](https://docs.docker.com/develop/dev-best-practices/)
- [å®¹å™¨å®‰å…¨æŒ‡å—](https://docs.docker.com/engine/security/)

