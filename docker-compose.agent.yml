# Plum 离线部署配置 - Docker Compose 1.25.0 兼容版本
# 适用于银河麒麟V10 ARM64环境

version: '3.3'

services:
  
  plum-agent:
    image: plum-agent:offline
    container_name: plum-agent
    network_mode: host
    user: "0"  # 或者使用 group_add，把 docker.sock 所在组加入容器
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # Docker socket（容器模式需要，用于管理应用容器）
      - /tmp/plum-agent:/tmp/plum-agent
      - plum-agent-data:/app/data
      - ./agent-go/.env:/app/.env:ro
      - /usr/lib:/usr/lib:ro
      - /usr/local/lib:/usr/local/lib:ro
      - /usr/lib/aarch64-linux-gnu:/usr/lib/aarch64-linux-gnu:ro
    #environment:
      # - AGENT_NODE_ID=nodeA
      # - CONTROLLER_BASE=http://plum-controller:8080
      # - AGENT_IP=plum-agent
      # - AGENT_DATA_DIR=/app/data
      # 容器模式配置（可选，如需使用容器模式部署应用）
      # - AGENT_RUN_MODE=docker  # 应用容器模式：process（默认）或 docker
      # - PLUM_BASE_IMAGE=ubuntu:22.04  # 应用容器基础镜像（推荐ubuntu:22.04，兼容glibc应用）
      # - PLUM_BASE_IMAGE=openeuler/openeuler:22.03  # 应用容器基础镜像（华为开源操作系统，适合企业级应用）
      # - PLUM_BASE_IMAGE=kylin/kylin:v10-release-020  # 应用容器基础镜像（银河麒麟，适用于国产化环境）
      # - PLUM_CONTAINER_MEMORY=512m  # 容器内存限制（可选）
      # - PLUM_CONTAINER_CPUS=1.0  # 容器CPU限制（可选）
      # - PLUM_HOST_LIB_PATHS=/usr/lib,/usr/local/lib  # 宿主机库路径映射（可选）
      # - PLUM_CONTAINER_ENV=DISPLAY=:99  # 容器自定义环境变量（可选）
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "plum-agent"]
      interval: 30s
      timeout: 10s
      retries: 3

# 数据卷配置
volumes:
  plum-agent-data:
    driver: local
