# Plum Controller 测试环境 - 简化版本
# 使用命名卷避免权限问题

version: '3.8'

# 指定项目名
name: controller-test

services:
  # Plum Controller 测试服务
  controller:
    build:
      context: .
      dockerfile: docker/controller/Dockerfile
    container_name: plum-controller-test
    ports:
      - "8080:8080"
    volumes:
      # 使用命名卷而不是绑定挂载
      - plum-test-data:/app/data
      # 配置文件映射
      - ./controller/.env:/app/.env:ro
    environment:
      # Controller配置
      - CONTROLLER_ADDR=:8080
      - CONTROLLER_DB=file:/app/data/controller-test.db?_pragma=busy_timeout(5000)
      - CONTROLLER_DATA_DIR=/app/data
      # 性能优化配置
      - HEARTBEAT_TTL_SEC=30
      - FAILOVER_ENABLED=true
      - TASK_SCHED_INTERVAL_SEC=1
    networks:
      - plum-test-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# 网络配置
networks:
  plum-test-network:
    driver: bridge
    name: plum-test-network

# 数据卷配置
volumes:
  plum-test-data:
    driver: local
